<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>CarShop - Gi·ªè h√†ng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .cart-img { width: 80px; height: 50px; object-fit: cover; }

    /* Th∆∞∆°ng hi·ªáu n·ªïi b·∫≠t */
    .navbar-brand {
      font-size: 1.6rem;
      font-weight: 700;
      letter-spacing: 0.6px;
      color: #fff !important;
      text-shadow: 0 2px 6px rgba(0,0,0,0.45);
    }

    /* üìå Menu x·ªï xu·ªëng cƒÉn ph·∫£i */
    .navbar-collapse {
      text-align: right;
    }
    .navbar-nav {
      margin-left: auto;
    }
    .navbar-nav .nav-item {
      text-align: right;
    }
    /* Th√¥ng b√°o ho√†n t√°c khi x√≥a s·∫£n ph·∫©m */
    .undo-toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: #fff;
      color: #222;
      padding: 12px 14px;
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      display: none;
      align-items: center;
      gap: 10px;
      z-index: 2000;
    }
    .undo-toast.show { display: flex; }
    .undo-toast button { background: transparent; border: none; color: #0d6efd; cursor: pointer; font-weight: 600; }
    .btn-trash {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 8px;
      width: 36px;
      height: 36px;
      border-radius: 6px;
    }
    .btn-trash svg { pointer-events: none; }
    /* Snackbar chung cho th√¥ng b√°o (kh√¥ng ch·∫∑n) */
    .snackbar { position: fixed; left: 50%; transform: translateX(-50%); bottom: 20px; background: rgba(20,20,20,0.95); color: #fff; padding: 10px 14px; border-radius: 8px; display: flex; gap: 12px; align-items: center; box-shadow: 0 8px 24px rgba(0,0,0,0.3); opacity: 0; pointer-events: none; transition: opacity 0.25s ease, transform 0.25s ease; z-index: 3000; }
    .snackbar.show { opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(0); }
    .snackbar .btn-sb { background: transparent; border: 1px solid rgba(255,255,255,0.12); color: #fff; padding: 6px 10px; border-radius: 6px; cursor: pointer; }
  </style>
</head>
<body>

  <!-- ‚úÖ Navbar ƒë·ªìng b·ªô v·ªõi index.html -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">CarShop</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav text-end">
          <li class="nav-item"><a class="nav-link" href="index.html">Trang ch·ªß</a></li>
          <li class="nav-item"><a class="nav-link" href="contact.html">Li√™n h·ªá</a></li>
          <li class="nav-item position-relative">
            <a class="nav-link active" href="cart.html">Gi·ªè h√†ng üõí</a>
            <span id="cartCount"
              class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- ‚úÖ C√≥ th√™m pt-5 ƒë·ªÉ tr√°nh b·ªã navbar che -->
  <div class="container my-5 pt-5">
    <h2 class="text-center mb-4">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>
    <table class="table table-bordered text-center align-middle" id="cartTable">
      <thead class="table-dark">
        <tr>
          <th style="width:44px;"><input type="checkbox" id="selectAll"></th>
          <th>S·∫£n ph·∫©m</th>
          <th>Gi√°</th>
          <th>S·ªë l∆∞·ª£ng</th>
          <th>T·ªïng</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="text-end mb-3">
      <h5>T·ªïng (ƒë√£ ch·ªçn): <span id="selectedTotal">0</span> VNƒê</h5>
      <h4>T·ªïng t·∫•t c·∫£: <span id="totalPrice">0</span> VNƒê</h4>
    </div>
  <div id="checkoutArea" class="d-flex justify-content-end align-items-center gap-3 mb-2">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="" id="agreeCheckbox">
        <label class="form-check-label small text-muted" for="agreeCheckbox">
          T√¥i ƒë·ªìng √Ω v√† x√°c nh·∫≠n th√¥ng tin ƒë·ªÉ thanh to√°n
        </label>
      </div>
      <div>
        <button class="btn btn-success" id="checkoutBtn" disabled>Thanh to√°n</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    // selection state parallel to cart (true = selected)
    let selected = [];
    // try to restore previous selection
    try{
      const saved = JSON.parse(localStorage.getItem('cart_selected'));
      if(Array.isArray(saved) && saved.length === cart.length){
        selected = saved.slice();
      } else {
        selected = cart.map(()=>true);
      }
    }catch(e){ selected = cart.map(()=>true); }
    const selectAllCheckbox = document.getElementById('selectAll');
  const tbody = document.querySelector("#cartTable tbody");
  const totalPriceEl = document.getElementById("totalPrice");
  const selectedTotalEl = document.getElementById('selectedTotal');
  const cartCount = document.getElementById("cartCount");
  const checkoutBtn = document.getElementById('checkoutBtn');
  const agreeCheckbox = document.getElementById('agreeCheckbox');

    function updateCheckoutState(){
      const hasItems = cart.length > 0;
      const anySelected = selected.some(Boolean);
      const agreed = agreeCheckbox ? agreeCheckbox.checked : false;
      if(checkoutBtn){
        // require at least one selected item AND agreement
        checkoutBtn.disabled = !(hasItems && anySelected && agreed);
      }
      // update selectAll checkbox state
      if(selectAllCheckbox){
        selectAllCheckbox.checked = cart.length>0 && selected.every(Boolean);
        selectAllCheckbox.indeterminate = selected.some(Boolean) && !selected.every(Boolean);
      }
    }

    function renderCart() {
      tbody.innerHTML = "";
      let total = 0;
      let selectedTotal = 0;
      cart.forEach((item, index) => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;
        if(selected[index]) selectedTotal += itemTotal;
        tbody.innerHTML += `
          <tr>
            <td><input type="checkbox" class="row-select" data-i="${index}" ${selected[index] ? 'checked' : ''}></td>
            <td class="d-flex align-items-center gap-2">
              <img src="${item.img}" alt="${item.name}" class="cart-img">
              <span>${item.name}</span>
            </td>
            <td>${item.price.toLocaleString()}</td>
            <td>
              <button class="btn btn-sm btn-secondary" onclick="changeQuantity(${index},-1)">-</button>
              ${item.quantity}
              <button class="btn btn-sm btn-secondary" onclick="changeQuantity(${index},1)">+</button>
            </td>
            <td>${itemTotal.toLocaleString()}</td>
            <td>
              <button class="btn btn-sm btn-danger btn-trash" onclick="removeItem(${index})" aria-label="X√≥a ${item.name}" title="X√≥a">
                <!-- Trash SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16" aria-hidden="true">
                  <path d="M5.5 5.5A.5.5 0 0 1 6 5h4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5H6a.5.5 0 0 1-.5-.5v-7z"/>
                  <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 1 1 0-2h3.086a1 1 0 0 0 .707-.293L7.5 0h1l.207.207A1 1 0 0 0 9.414.5H12a1 1 0 1 1 0 2H14a1 1 0 0 1 .5.5zM4.118 4L4 14a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1L11.882 4H4.118z"/>
                </svg>
              </button>
            </td>
          </tr>
        `;
      });
  totalPriceEl.textContent = total.toLocaleString();
  selectedTotalEl.textContent = selectedTotal.toLocaleString();
      cartCount.textContent = cart.reduce((acc,item)=>acc+item.quantity,0);
      localStorage.setItem("cart", JSON.stringify(cart));
  // persist selected state too (non-essential but handy across reloads)
  localStorage.setItem('cart_selected', JSON.stringify(selected));
      // c·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t thanh to√°n
      updateCheckoutState();
      // attach listeners for row checkboxes
      document.querySelectorAll('.row-select').forEach(cb => {
        cb.addEventListener('change', function(e){
          const i = parseInt(this.getAttribute('data-i'));
          selected[i] = !!this.checked;
          // update selected totals and button states
          renderCart();
        });
      });
      // ensure selectAll handler wired
      if(selectAllCheckbox){
        selectAllCheckbox.addEventListener('change', function(){
          const v = !!this.checked;
          selected = cart.map(()=>v);
          renderCart();
        });
      }
      // ·∫©n/hi·ªán khu v·ª±c checkbox + checkout khi kh√¥ng c√≥ s·∫£n ph·∫©m
      const checkoutArea = document.getElementById('checkoutArea');
      if(checkoutArea){
        if(cart.length === 0){
          checkoutArea.style.display = 'none';
          // b·ªè tick n·∫øu c√≥
          if(agreeCheckbox) { agreeCheckbox.checked = false; }
        } else {
          checkoutArea.style.display = 'flex';
        }
      }
    }

    function changeQuantity(i, delta){
      cart[i].quantity += delta;
      if(cart[i].quantity < 1) cart[i].quantity = 1;
      renderCart();
    }

    function removeItem(i){
      // X√≥a ngay l·∫≠p t·ª©c nh∆∞ng cho ph√©p ho√†n t√°c trong v√†i gi√¢y
      const removed = cart.splice(i,1)[0];
      // c≈©ng lo·∫°i b·ªè tr·∫°ng th√°i ch·ªçn t∆∞∆°ng ·ª©ng
      const removedSelected = selected.splice(i,1)[0];
      renderCart();

      // l∆∞u t·∫°m ƒë·ªÉ ho√†n t√°c
      window.lastRemoved = { item: removed, index: i };
      const toast = document.getElementById('undoToast');
      toast.querySelector('.msg').textContent = `ƒê√£ x√≥a "${removed.name}"`;
      toast.classList.add('show');

      // h·ªßy timer n·∫øu c√≥
      if(window.undoTimer) clearTimeout(window.undoTimer);
      window.undoTimer = setTimeout(()=>{
        toast.classList.remove('show');
        window.lastRemoved = null;
        window.undoTimer = null;
      }, 5000);
    }

    // Ho√†n t√°c x√≥a
    function undoRemove(){
      const last = window.lastRemoved;
      const toast = document.getElementById('undoToast');
      if(!last) return;
      // ch√®n l·∫°i v√†o v·ªã tr√≠ c≈© (n·∫ø
      // u v·ªã tr√≠ l·ªõn h∆°n ƒë·ªô d√†i hi·ªán t·∫°i, th√™m cu·ªëi)
      const idx = Math.min(last.index, cart.length);
      cart.splice(idx, 0, last.item);
      // restore selection state for this item (true by default)
      selected.splice(idx, 0, true);
      renderCart();
      toast.classList.remove('show');
      if(window.undoTimer) clearTimeout(window.undoTimer);
      window.lastRemoved = null;
      window.undoTimer = null;
    }

    // Hi·ªÉn th·ªã snackbar (d√πng l·∫°i c√πng ki·ªÉu v·ªõi product/index)
    function showSnackbar(message){
      const sb = document.getElementById('snackbar');
      console.log('showSnackbar called:', message, 'snackbar found:', !!sb);
      if(!sb){
        // N·∫øu kh√¥ng c√≥ ph·∫ßn t·ª≠ snackbar (do l·ªói DOM), fallback sang alert
        alert(message);
        return;
      }
      const msg = sb.querySelector('.sb-msg');
      if(msg) msg.textContent = message;
      // ƒë·∫£m b·∫£o visible
      sb.style.display = 'flex';
      // th√™m class ƒë·ªÉ b·∫≠t animation/opacity
      sb.classList.add('show');
      if(window._sbTimer) clearTimeout(window._sbTimer);
      window._sbTimer = setTimeout(()=> sb.classList.remove('show'), 3500);
    }

    document.getElementById("checkoutBtn").addEventListener("click", function(){
      // ch·ªâ x·ª≠ l√Ω nh·ªØng s·∫£n ph·∫©m ƒë∆∞·ª£c ch·ªçn
      const itemsToPay = cart.filter((_,i)=>selected[i]);
      if(itemsToPay.length === 0){
        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n.');
        return;
      }
      console.log('checkout clicked, selected items:', itemsToPay);
      // Hi·ªÉn th·ªã snackbar c·∫£m ∆°n
      showSnackbar('C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ mua h√†ng');
      // sau th√¥ng b√°o, lo·∫°i b·ªè c√°c s·∫£n ph·∫©m ƒë√£ thanh to√°n kh·ªèi cart
      setTimeout(()=>{
        // gi·ªØ l·∫°i nh·ªØng item kh√¥ng ƒë∆∞·ª£c ch·ªçn
        const remaining = cart.filter((_,i)=>!selected[i]);
        cart = remaining;
        // rebuild selected array
        selected = cart.map(()=>true);
        renderCart();
        // B·ªè tick checkbox sau khi thanh to√°n xong v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t
        if(agreeCheckbox){
          agreeCheckbox.checked = false;
          updateCheckoutState();
        }
      }, 800);
    });

    renderCart();

    // B·∫≠t/t·∫Øt checkout khi tick checkbox
    if(agreeCheckbox){
      agreeCheckbox.addEventListener('change', updateCheckoutState);
    }
  </script>

  <!-- Th√¥ng b√°o ho√†n t√°c x√≥a -->
  <div id="undoToast" class="undo-toast" role="status" aria-live="polite">
    <span class="msg">ƒê√£ x√≥a</span>
    <button onclick="undoRemove()">Ho√†n t√°c</button>
  </div>

  <!-- Snackbar cho th√¥ng b√°o chung -->
  <div id="snackbar" class="snackbar" role="status" aria-live="polite">
    <div class="sb-msg">&nbsp;</div>
    <button class="btn-sb" id="viewCartBtn" style="display:none">Xem gi·ªè h√†ng</button>
  </div>
<!-- ‚úÖ Ki·ªÉm tra ƒëƒÉng nh·∫≠p v√† hi·ªÉn th·ªã l·ªùi ch√†o 3 gi√¢y + n√∫t ƒêƒÉng xu·∫•t -->
<script>
  const loggedUser = localStorage.getItem("loggedUser");
  if (loggedUser) {
    const navbar = document.querySelector(".navbar-nav");
    if (navbar && !document.getElementById("greetingNavItem")) {
      const li = document.createElement("li");
      li.className = "nav-item d-flex align-items-center";
      li.id = "greetingNavItem";

      const span = document.createElement("span");
      span.className = "nav-link text-success fw-bold";
      span.id = "greetingText";
      span.textContent = `Xin ch√†o, ${loggedUser.split("@")[0]} üëã`;

      const btn = document.createElement("button");
      btn.className = "btn btn-outline-light btn-sm ms-2";
      btn.textContent = "ƒêƒÉng xu·∫•t";

      li.appendChild(span);
      li.appendChild(btn);
      navbar.appendChild(li);

      // Sau 3 gi√¢y t·ª± ·∫©n l·ªùi ch√†o, ch·ªâ c√≤n n√∫t ƒëƒÉng xu·∫•t
      setTimeout(() => {
        const g = document.getElementById("greetingText");
        if (g) g.style.display = "none";
      }, 3000);

      // Khi nh·∫•n "ƒêƒÉng xu·∫•t" ‚Üí x√≥a ƒëƒÉng nh·∫≠p v√† quay v·ªÅ trang ch·ªß
      btn.addEventListener("click", () => {
        localStorage.removeItem("loggedUser");
        alert("B·∫°n ƒë√£ ƒëƒÉng xu·∫•t!");
        location.href = "index.html";
      });
    }
  }
</script>
</body>
</html>
